<!--
    2020-04-01 nathan.franklin@auspost.com.au Created
    2020-10-05 - Disha Kariya - Allow safe drop attachment for case creation
    2020-10-12 - Ranjeewa Silva - Added support for Direct to Network case creation.
    2021-06-15 - Ranjeewa Silva - Updated 'readOnly' property name as per https://developer.salesforce.com/docs/component-library/documentation/en/lwc/lwc.js_props_names.
-->
<template>
	<article class={happyParcelCssClass}>
		<div class="slds-box_border article-selector">
			<c-happy-parcel-article-selector read-only={selectorReadOnly} loading={loading} tracking-id={trackingId} onsearch={handleSearch}>
			</c-happy-parcel-article-selector>
		</div>

		<template for:each={errors} for:item="error">
			<div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error" role="alert" key={error}>
				<span class="slds-assistive-text">error</span>
				<h2>{error}</h2>
			</div>
		</template>
		<template if:true={retryAnalytics}>
			<div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error" role="alert" key={error}>
				<span class="slds-assistive-text">error</span>
				<h2>
					<span class="slds-show_inline-block slds-align-middle">Analytics API failed, please retry.</span>
					<span class="slds-show_inline-block slds-align-middle slds-m-left_small"><lightning-button variant="destructive-text" label="Try Again" onclick={handleRetriggerAnalyticsSearch}></lightning-button></span>
				</h2>
			</div>
		</template>

		<template if:true={isConsignment}>
			<div class="slds-grid slds-wrap slds-grid_vertical-stretch slds-m-top_medium slds-gutters_direct-x-small">
				<!-- Sender / Receiver details -->
				<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-m-bottom_medium">
					<c-happy-parcel-customer-details detail-type="1" loading={loading}
					                                 contact={consignmentSenderContact}
					                                 tracking-api-result={consignmentTrackingResult}
					                                 supports-customer-selection={supportsCustomerSelection}
					                                 selected={consignmentSenderSelected}
					                                 oncustomerselect={handleConsignmentCustomerSelected}
					                                 oncustomerdeselect={handleConsignmentCustomerDeselected}
					                                 animation-delay="0">
					</c-happy-parcel-customer-details>
				</div>
				<div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-m-bottom_medium">
					<c-happy-parcel-customer-details detail-type="2" loading={loading}
					                                 contact={consignmentReceiverContact}
					                                 tracking-api-result={consignmentTrackingResult}
					                                 supports-customer-selection={supportsCustomerSelection}
					                                 selected={consignmentReceiverSelected}
					                                 oncustomerselect={handleConsignmentCustomerSelected}
					                                 oncustomerdeselect={handleConsignmentCustomerDeselected}
					                                 animation-delay="100">
					</c-happy-parcel-customer-details>
				</div>

				<!-- Consignment Details -->
				<div class="slds-col slds-size_1-of-1 slds-m-bottom_medium">
					<c-happy-parcel-article-details loading={loadingTrackingApi}
					                                tracking-api-result={consignment.trackingResult}
					                                animation-delay="150"
					                                animation-speed="500"
					                                use-consignment-field-set>
					</c-happy-parcel-article-details>
				</div>
			</div>

			<div class="slds-card slds-card_boundary">
				<lightning-accordion allow-multiple-sections-open active-section-name={activeSections} onsectiontoggle={handleToggleSection}>
					<template for:each={articles} for:item="article">
						<lightning-accordion-section name={article.trackingId} label={article.trackingId} key={article.trackingId} class="slds-is-relative">
							<div slot="actions" class="article-status-slot slds-grid slds-grid_vertical-align-center">
								<!-- use code to set hideAccordionSummary to true when we expand the individual panel -->
								<template if:false={article.hideAccordionSummary}>
									<c-happy-parcel-milestone-path loading-tracking-api={loadingTrackingApi}
									                               tracking-api-result={article.trackingResult}
									                               class="slds-show_inline-block"
									                               variant="compact"
									>
									</c-happy-parcel-milestone-path>
								</template>

								<template if:true={supportsSelectableChildArticles}>
									<div class="slds-show_inline-block slds-box_border slds-m-left_large slds-is-relative" data-article={article.trackingId} style="width:30px;height:30px;" onclick={handleArticleSelectorClick}>
										<div style="pointer-events:none;">
											<template if:true={article.articleSelected}>
												<c-happy-parcel-custom-icon icon="tick" size="small" style="position:absolute;top:50%;left:50%;margin-left:-10px;margin-top:-10px;"></c-happy-parcel-custom-icon>
											</template>
										</div>
									</div>
								</template>
							</div>

							<c-happy-parcel-article article={article} read-only={readOnly}
							                        loading-tracking-api={loadingTrackingApi}
							                        loading-analytics-api={loadingAnalyticsApi}
							                        supports-external-edd={supportsExternalEdd}
							                        is-article-consignment
							                        is-article-selected={article.articleSelected}
							                        supports-delivery-proof-attachment={supportsSafeDropAttachment}>
							</c-happy-parcel-article>
						</lightning-accordion-section>
					</template>
				</lightning-accordion>
			</div>
		</template>

		<template if:false={isConsignment}>
			<template for:each={articles} for:item="article">
				<c-happy-parcel-article article={article} read-only={readOnly}
				                        loading-tracking-api={loadingTrackingApi}
				                        loading-analytics-api={loadingAnalyticsApi}
				                        supports-external-edd={supportsExternalEdd}
				                        supports-customer-selection={articleCustomerSelectionEnabled}
				                        supports-delivery-proof-attachment={supportsSafeDropAttachment}
										supports-case-creation={supportsCaseCreation}
										host-context={hostContext}
				                        is-article-selected
				                        key={article.trackingId}>
				</c-happy-parcel-article>
			</template>
		</template>

		<template if:true={isConsignment}>
			<template if:true={consignmentHasEventMessages}>
				<!-- consignment event messages -->
				<div class="slds-col slds-size_1-of-1 slds-m-vertical_medium">
					<c-happy-parcel-event-messages loading={loadingTrackingApi} event-messages={consignment.trackingResult.events}>
					</c-happy-parcel-event-messages>
				</div>
			</template>
		</template>

	</article>
</template>