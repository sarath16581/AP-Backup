<!--
* @author Andrew Judd ajudd@salesforce.com 
* @date 2020-07-01
* @domain Field Service 
* @description  Form to edit job from Edit Job Action on FSL Gantt.
*                Has custom lookup to select valid related collect/deliver work orders
*                Primary function is to connect related collect or deliver work order and update requested quanitities
*
* @changelog 
* 2020-07-01 - Andrew Judd - Created 
-->
<apex:page controller="TDF_EditJobController">
    
    <html xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <apex:stylesheet value="{!URLFOR($Resource.TDFLightningCSS, 'assets/styles/salesforce-lightning-design-system-vf.min.css')}" />
    <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"/>  
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha256-KXn5puMvxCw+dAYznun+drMdG1IFl3agK0p/pqT9KAo= sha512-2e8qq0ETcfWRI4HJBzQiA3UoyFk6tbNyG+qSaIBZLyW9Xf3sWZHN/lxe9fTh1U45DpPf07yj94KsUHHWe4Yk1A==" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>

    <script>   

        //Custom lookup Begin
        function openLookup(baseURL, width, modified, searchParam){         
            var originalbaseURL = baseURL;
            var originalwidth = width;
            var originalmodified = modified;
            var originalsearchParam = searchParam;
            var saId;
            var lookupType = baseURL.substr(baseURL.length-3, 3);
            
            if (modified == '1') baseURL = baseURL + searchParam;

            var isCustomLookup = false;

            //If "0WO" the the lookup type for Work Order object has been detected
            if(lookupType == "0WO"){

                var urlArr = baseURL.split("&");
                var txtId = '';
                if(urlArr.length > 2) {
                    urlArr = urlArr[1].split('=');
                    txtId = urlArr[1];
                }

                //Set the url of Custom Lookup page.
                baseURL = "/apex/TDF_CustomRelatedWOLookup?txt=" + txtId;

                //Following is the id of apex:form control "frmOne"
                baseURL = baseURL + "&frm=" + escapeUTF("{!$Component.frmOne}");
                if (modified == '1') {
                    baseURL = baseURL + "&lksearch=" + searchParam;
                }

                //If lookup launched from collect from or Deliver to WOLI field
                if((txtId.indexOf('woliDTCFWO') > -1) || (txtId.indexOf('woliCFDTWO') > -1 )){
                    
                    //Get the SA Id from the current page
                    var url_string = window.location.href;
                    var url = new URL(url_string);
                    saId = url.searchParams.get("id");
                    
                    //Add to the base URL as a parameter to retrieve from the controller
                    baseURL = baseURL + "&saId=" + saId;
                    
                    //If off deliver to task
                    if((txtId.indexOf('woliDTCFWO') > -1)){
                        //Add task paramater the base URL
                    	baseURL = baseURL + "&task=DT";
                    }
                    //If off collect from task
                    if((txtId.indexOf('woliCFDTWO') > -1)){
                        //Add task paramater the base URL
                    	baseURL = baseURL + "&task=CF";
                    }
                                        
                    isCustomLookup = true;
                }
            }

            if(isCustomLookup == true){             
                openPopup(baseURL, "lookup", 350, 480, "width=800,height=580,toolbar=no,status=no,directories=no,menubar=no,resizable=yes,scrollable=no", true);
            }
            else{
                if(modified == '1') originalbaseURL = originalbaseURL + originalsearchParam;
                openPopup(originalbaseURL, "lookup", 350, 480, "width="+originalwidth+",height=580,toolbar=no,status=no,directories=no,menubar=no,resizable=yes,scrollable=no", true);
            } 
        } 
        //Custom Lookup Ends

    </script>

    <apex:form id="editJobForm">
    <apex:pageMessages id="pgMsg"></apex:pageMessages>
    <apex:slds /> 

        <apex:actionFunction name="addWOLICF" action="{!addWOLICF}" reRender="editJobForm" status="statusOne"/>
        <apex:actionFunction name="addWOLIDT" action="{!addWOLIDT}" reRender="editJobForm" status="statusOne"/>
        
        <div style="width: 100%">
                    <!-- Work Order Section Begin-->                                                       
                    <div class="slds-form slds-form_compound">
                        
                        <div class="slds-tree__item" id="divOne" style="background-color: #cfe1f1;">
                            <button class="slds-button slds-button--icon slds-m-right--x-small" type="button" role="presentation" onclick="toggle_visibility('viewWorkOrderSection');" title="Toggle" style="margin-left: -1%;">
                              <div class="sdls-icon_container">
                                <svg aria-hidden="true" class="slds-button__icon slds-button__icon--small">
                                    <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.TDFLightningCSS, "/assets/icons/utility-sprite/svg/symbols.svg#chevronright")}" />
                                </svg>                                
                              </div>
                            </button>
                            <a id="tree0-node1__label" href="javascript:void(0);" role="presentation" onclick="toggle_visibility('createJobTemplateSection1');" class="slds-truncate" title="Tree Branch"><b>Work Order</b></a>
                        </div><br/>

                        <div id="viewWorkOrderSection">
                            <fieldset class="slds-form-element">
                                <div class="slds-form-element__group">
                                    <div class="slds-form-element__row">
                                        
                                        <div class="slds-form-element slds-size_1-of-3">
                                            <label class="slds-form-element__label" for="woActivity"><b>Activity</b></label><br/>
                                            <apex:outputField value="{!objWO.Activity_Type__c}" styleClass="slds-lookup__search-input slds-input" style="width: 75%" id="woActivity"/>
                                        </div> 
                                        <div class="slds-form-element slds-size_1-of-3">
                                            <label class="slds-form-element__label" for="woStart"><b>Scheduled Start</b></label><br/>
                                            <apex:outputField value="{!objWO.Primary_SA__r.SchedStartTime}" styleClass="slds-lookup__search-input slds-input" style="width: 75%" id="woStart"/>
                                        </div>
                                        <div class="slds-form-element slds-size_1-of-3">
                                            <label class="slds-form-element__label" for="woLoc"><b>Location</b></label><br/>
                                            <apex:outputField value="{!objWO.Location.Name}" styleClass="slds-lookup__search-input slds-input" style="width: 75%" id="woLoc"/>
                                        </div>
                               
                                    </div>
                                                         
                                </div>
                            </fieldset>
                        </div>
                    </div>
                    <!-- Work Order Section End-->
            
                    <!-- Work Order Line Item Deliver To Section Begin-->
                    <apex:outputPanel rendered="{!renderWOLIs}" id="outputPanelWOLIDT">
                        <div class="slds-form slds-form_compound">
                            <div class="slds-tree__item" id="divOne" style="background-color: #cfe1f1;">
                                <button class="slds-button slds-button--icon slds-m-right--x-small" type="button" role="presentation" onclick="toggle_visibility('woliDTSection1');" title="Toggle" style="margin-left: -0.5%;">
                                <div class="sdls-icon_container">
                                    <svg aria-hidden="true" class="slds-button__icon slds-button__icon--small">
                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.TDFLightningCSS, "/assets/icons/utility-sprite/svg/symbols.svg#chevronright")}" />
                                    </svg>                                
                                </div>
                                </button>
                                <a id="tree0-node1__label" href="javascript:void(0);" role="presentation" onclick="toggle_visibility('woliDTSection1');" class="slds-truncate" title="Tree Branch"><b>Deliver Work Order Line Items</b></a>
                            </div><br/>
                            <div id="woliDTSection">
                                <fieldset class="slds-form-element">
                                    <div class="slds-form-element__group">
                                        <div class="slds-form-element__row">                                    
                                            <div class="slds-form-element slds-size_1-of-1">
                                                <table style="width:100%;">    
                                                    <thead>
                                                        <tr>
                                                            <th style="width: 5%">Action</th>
                                                            <th style="width: 12%">Product</th>
                                                            <th style="width: 5%">Qty</th>
                                                            <th style="width: 7%">Dock Num</th>
                                                            <th style="width: 12%">Collect From Job</th>
                                                            <th style="width: 12%">Collect From Start</th>
                                                            <th style="width: 20%">Collect From Location</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>                                                 
                                                        <apex:variable var="i" value="{!0}"/>
                                                            <apex:repeat value="{!woliDTList}" var="woliDT"> 
                                                            <tr style="">
                                                                <td>
                                                                    <apex:commandLink value="Delete" action="{!deleteDTWOLI}" rendered="{!woliDTList.size>0}" reRender="editJobForm" status="statusOne">
                                                                        <apex:param name="index" assignTo="{!selectedWOLIDTIndex}" value="{!i}"/>
                                                                    </apex:commandLink>
                                                                </td>
                                                                <td><apex:inputField value="{!woliDT.Product__c}" styleClass="slds-lookup__search-input slds-input" style="width: 75%" id="woliDTProd"/></td>
                                                                <td><apex:inputField value="{!woliDT.Requested_Quantity__c}" styleClass="slds-input" style="width: 100%" id="woliDTReqQty"/></td>
                                                                <td><apex:inputField value="{!woliDT.Deliver_To_Dock_Number__c}" styleClass="slds-input" style="width: 100%" id="woliDTDocNum"/></td>
                                                                <td><apex:inputField value="{!woliDT.Collect_From_Work_Order__c}" styleClass="slds-lookup__search-input slds-input" style="width: 75%" id="woliDTCFWO"/></td>
                                                                <td><apex:outputField value="{!woliDT.Collect_From_Work_Order__r.Primary_SA__r.SchedStartTime}" styleClass="slds-input" style="width: 100%" id="woliDTCFWOStart"/></td> 
                                                                <td><apex:outputField value="{!woliDT.Collect_From_Work_Order__r.Location.Name}" styleClass="slds-input" style="width: 100%" id="woliDTCFWOLoc"/></td>
                                                            </tr>
                                                            <apex:variable var="i" value="{!i+1}"/>
                                                        </apex:repeat>
                                                    
                                                    </tbody>
                                                    <tfoot>
                                                        <tr>
                                                            <td class="dataCell" colspan="4" style="text-align:left; font-size:20px;">
                                                                <a href="javascript:addWOLIDT();" title="Add Work Order Line Item"><i class="fa fa-plus-circle" aria-hidden="true"/></a>
                                                            </td>
                                                        </tr>
                                                    </tfoot>
                                                </table>                                                                            
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>                                                          
                        </div>
                    </apex:outputPanel>
                    <!-- Work Order Line Item Deliver To Section End-->                
            
                    <!-- Work Order Line Item Collect From Section Begin-->
                    <apex:outputPanel rendered="{!renderWOLIs}" id="outputPanelWOLICF">
                        <div class="slds-form slds-form_compound">
                            <div class="slds-tree__item" id="divOne" style="background-color: #cfe1f1;">
                                <button class="slds-button slds-button--icon slds-m-right--x-small" type="button" role="presentation" onclick="toggle_visibility('woliCFSection1');" title="Toggle" style="margin-left: -0.5%;">
                                <div class="sdls-icon_container">
                                    <svg aria-hidden="true" class="slds-button__icon slds-button__icon--small">
                                        <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="{!URLFOR($Resource.TDFLightningCSS, "/assets/icons/utility-sprite/svg/symbols.svg#chevronright")}" />
                                    </svg>                                
                                </div>
                                </button>
                                <a id="tree0-node1__label" href="javascript:void(0);" role="presentation" onclick="toggle_visibility('woliCFSection1');" class="slds-truncate" title="Tree Branch"><b>Collect Work Order Line Items</b></a>
                            </div><br/>
                            <div id="woliCFSection">
                                <fieldset class="slds-form-element">
                                    <div class="slds-form-element__group">
                                        <div class="slds-form-element__row">                                    
                                            <div class="slds-form-element slds-size_1-of-1">
                                                <table style="width:100%;">    
                                                    <thead>
                                                        <tr>
                                                            <th style="width: 5%">Action</th>
                                                            <th style="width: 12%">Product</th>
                                                            <th style="width: 5%">Qty</th>
                                                            <th style="width: 7%">Dock Num</th>
                                                            <th style="width: 12%">Deliver To Job</th>
                                                            <th style="width: 12%">Deliver To Start</th>
                                                            <th style="width: 20%">Deliver To Location</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>                                                 
                                                        <apex:variable var="i" value="{!0}"/>
                                                            <apex:repeat value="{!woliCFList}" var="woliCF"> 
                                                            <tr style="">
                                                                <td>
                                                                    <apex:commandLink value="Delete" action="{!deleteCFWOLI}" rendered="{!woliCFList.size>0}" reRender="editJobForm" status="statusOne">
                                                                        <apex:param name="index" assignTo="{!selectedWOLICFIndex}" value="{!i}"/>
                                                                    </apex:commandLink>
                                                                </td>
                                                                <td><apex:inputField value="{!woliCF.Product__c}" styleClass="slds-lookup__search-input slds-input" style="width: 75%" id="woliCFProd"/></td>
                                                                <td><apex:inputField value="{!woliCF.Requested_Quantity__c}" styleClass="slds-input" style="width: 100%" id="woliCFReqQty"/></td>
                                                                <td><apex:inputField value="{!woliCF.Collect_From_Dock_Number__c}" styleClass="slds-input" style="width: 100%" id="woliCFDocNum"/></td>
                                                                <td><apex:inputField value="{!woliCF.Deliver_To_Work_Order__c}" styleClass="slds-lookup__search-input slds-input" style="width: 75%" id="woliCFDTWO"/></td>
                                                                <td><apex:outputField value="{!woliCF.Deliver_To_Work_Order__r.Primary_SA__r.SchedStartTime}" styleClass="slds-input" style="width: 100%" id="woliCFDTWOStart"/></td> 
                                                                <td><apex:outputField value="{!woliCF.Deliver_To_Work_Order__r.Location.Name}" styleClass="slds-input" style="width: 100%" id="woliCFDTWOLoc"/></td>
                                                                
                                                            </tr>
                                                            <apex:variable var="i" value="{!i+1}"/>
                                                        </apex:repeat>
                                                    
                                                    </tbody>
                                                    <tfoot>
                                                        <tr>
                                                            <td class="dataCell" colspan="4" style="text-align:left; font-size:20px;">
                                                                <a href="javascript:addWOLICF();" title="Add Work Order Line Item"><i class="fa fa-plus-circle" aria-hidden="true"/></a>
                                                            </td>
                                                        </tr>
                                                    </tfoot>
                                                </table>                                                                            
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>                                                          
                        </div>
                    </apex:outputPanel>
                    <!-- Work Order Line Item Collect From Section End-->
                   
            
                    <!-- command button section Begin -->
                    <div id="commandButtonSection" style="margin-top: -1%;">
                        <fieldset class="slds-form-element">
                            <div class="slds-form-element__group">
                                <div class="slds-form-element__row">                                                                        
                                    <div class="slds-form-element slds-size_1-of-1" align="center">
                                        <apex:commandButton rendered="{!renderWOLIs}" value="Save" action="{!saveTemplates}" styleClass="slds-button slds-button_brand" status="statusOne"/>
                                        <apex:commandButton value="Cancel" onclick="parent.postMessage('closeLightbox','*');" styleClass="slds-button slds-button_brand" status="statusOne"/>
                                    </div>      
                                </div>
                            </div>
                        </fieldset>
                    </div>     
                    <!-- command button section End -->
            </div>
   
    </apex:form>

    <style>
        .lookupInput a{
            position: absolute;
            width: 33px !important; 
            margin-left: 5px;
            background-image: url(/img/setup/search-icon.png) !important;
            background-repeat: no-repeat !important;
            background-position: center !important;
            display: inline-flex !important;
        }
        .lookupInput a img{
            display:none !important;
        }
        .datetimeclass{
            width: 100%;
            background-color: #fff;
            color: #16325c;
            border: 1px solid #d8dde6;
            border-radius: .25rem;
            transition: border .1s linear,background-color .1s linear;
            display: inline-block;
            padding: 0 1rem 0 .75rem;
            line-height: 1.875rem;
            min-height: calc(1.875rem + (1px * 2));     
        }
        .container-fluid {
            margin-top: 10px;
        }

    </style>
    </html>    
    
</apex:page>