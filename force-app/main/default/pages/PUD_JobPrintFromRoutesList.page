<!--
 - Created by Kamil Szyc on 24/6/2022.
 -->
<apex:page docType="html-5.0" standardController="PUD_Route__c" extensions="PUD_PrintRouteController"
           recordSetVar="routesVar"
           renderAs="pdf" applyBodyTag="false" id="PUD_JobPrintFromRoutesList">
    <!--Page to allow printing of Duty for driver a backup to the mobile device -->
    <head>
        <style type="text/css" media="print">
            @page {
                @top-center {
                    content: element(header);
                }
            }
           @page {
                size: A4 portrait;
                margin-top:14mm;
           }
            div.header {
            font-size: small;
            position:running(header);
            }
           table {
    			-fs-table-paginate: paginate;
			}

            .pagenumber:before {
                content: counter(page);
            }
            .pagecount:before {
                content: counter(pages);
            }
            .table-header{
                border-bottom: 1px solid black;
                font-family:Arial Unicode MS;
                font-size: 10px;
            }
            table.info{
                border-top: 1px solid black;
                border-bottom: 1px solid black;
                border-spacing:1px;
            }
            td.bold{
                font-weight:bold;
                font-family:sans-serif;
            }
            .boldcell {
                font-size: 10pt;
                font-weight: bold;
                font-family: sans-serif;
                vertical-align: Top;
                padding-left: 5px;
                padding-top: 5px;
            }
            .normalcell {
                font-size: 10pt;
                font-family: "Arial Unicode MS";
                vertical-align: Top;
                padding-left: 5px;
                padding-top: 5px;
            }
            td.italic{
                font-style:italic;
            }
            .job-headers {
                font-weight:normal;
                font-size:small;
            }

        </style>

    </head>
    <!--page counter used to truncate blank pages and the end of the pdf document -->
    <apex:variable var="routeCounter" value="{!0}"/>
    <apex:repeat value="{!routes}" var="route" id="selectedRoutes">
        <div style="{!if(routeCounter < 1, 'page-break-before:avoid;','page-break-before:always;')}">
            <div class="header">
                <!--repeatable header-->
                <c:PUD_JobsHeader Route="{! route}"/>
            </div>
            <div class="content">
                <table class="info" style="background-color:white;">
                    <tr>
                        <td class="italic" style="width:100%; font-size:12px;">
                            <apex:outputText value="{! $Label.Route_Printing_Static_Text_Top}"/>
                            <br/>
                            <apex:outputText value="{! $Label.Route_Printing_Static_Text_Bottom}"/>
                        </td>
                    </tr>
                    <tr>
                        <!-- days and times the route is active -->
                        <td class="boldcell" style="display:inline-block; width:150px; vertical-align:top !important; font-size:12px;" >
                        <span class="left-align">
                                <apex:outputText rendered="{! route.Monday__c}" value="Mon "/>
                                <apex:outputText rendered="{! route.Tuesday__c}" value="Tue "/>
                                <apex:outputText rendered="{! route.Wednesday__c}" value="Wed "/>
                                <apex:outputText rendered="{! route.Thursday__c}" value="Thu "/>
                                <apex:outputText rendered="{! route.Friday__c}" value="Fri "/>
                                <apex:outputText rendered="{! route.Saturday__c}" value="Sat "/>
                                <apex:outputText rendered="{! route.Sunday__c}" value="Sun "/>
                            <!-- display time in hhmm format -->
                            {! IF(LEN(TEXT(HOUR(route.Start_Time__c)))<2 , '0'+ TEXT(HOUR(route.Start_Time__c)), HOUR(route.Start_Time__c))}
                            <apex:outputText value="{0,number,00}">
                                        <apex:param value="{!MINUTE(route.Start_Time__c)}"/>
                                    </apex:outputText>
                                -&nbsp;
                            {! IF(LEN(TEXT(HOUR(route.End_Time__c)))<2 , '0'+ TEXT(HOUR(route.End_Time__c)), HOUR(route.End_Time__c))}
                            <apex:outputText value="{0,number,00}">
                                        <apex:param value="{!MINUTE(route.End_Time__c)}"/>
                                    </apex:outputText>
                            </span>
                        </td>
                        <td class="bold" style="font-size:12px; text-align:right; vertical-align:top; display:inline-block; width:200px;">
                            Overtime: <apex:outputText value="{!route.Overtime_Allowance__c}"/>
                        </td>
                        <td  class="bold" style="font-size:12px; text-align:right; vertical-align:top; display:inline-block; width:90px;">
                            <!-- rest breaks -->
                            Rest Break:
                        </td>
                        <td class="bold" style="font-size:12px; display:inline-block; vertical-align:top;">
                            <apex:variable var="breaksNumber" value="{!0}"/>
                            <apex:repeat value="{!route.Bookings__r}" var="booking">
                                <apex:outputText
                                        rendered="{! AND(breaksNumber>0, booking.Booking_Type__c='Meal Break')}">
                                    <br/>
                                </apex:outputText>
                                <apex:outputText rendered="{! booking.Booking_Type__c='Meal Break'}">
                                    {!booking.Booking_Location_Name_LU__c} &nbsp;
                                    {! IF(LEN(TEXT(HOUR(booking.Start_Time__c)))<2 , '0'+ TEXT(HOUR(booking.Start_Time__c)), HOUR(booking.Start_Time__c))}
                                </apex:outputText>
                                <apex:outputText value="{0,number,00}"
                                                 rendered="{! booking.Booking_Type__c='Meal Break'}">
                                    <apex:param value="{!MINUTE(booking.Start_Time__c)}"/>
                                </apex:outputText>
                                <apex:variable var="breakEndTime"
                                               value="{! booking.Start_Time__c+booking.Dwell_Time_Planned__c*60000}"/>
                                <apex:outputText rendered="{! booking.Booking_Type__c='Meal Break'}">
                                    -
                                    {! IF(LEN(TEXT(HOUR(breakEndTime)))<2 , '0'+ TEXT(HOUR(breakEndTime)), HOUR(breakEndTime))}
                                </apex:outputText>
                                <apex:outputText value="{0,number,00}"
                                                 rendered="{! booking.Booking_Type__c='Meal Break'}">
                                    <apex:param value="{!MINUTE(breakEndTime)}"/>
                                </apex:outputText>
                                <apex:outputText
                                        rendered="{!  booking.Booking_Type__c='Meal Break'}">
                                    <apex:variable var="breaksNumber" value="{!breaksNumber+1}"/>
                                </apex:outputText>
                            </apex:repeat>
                        </td>
                    </tr>
                </table>
                <apex:pageBlock>
                    <!-- bookings table -->
                    <apex:pageBlockTable value="{! route.Bookings__r }" var="booking"
                                         styleClass="normalcell"
                                         headerClass="table-header">
                        <apex:column headerValue="Arrive"
                                     styleClass="normalcell"
                                     width="50px"
                                     headerClass="job-headers" rendered="{!booking.Booking_Type__c != 'Meal Break'}">
                            <div class="boldcell">
                                <!-- display time in hhmm format -->
                                {! IF(LEN(TEXT(HOUR(booking.Start_Time__c)))<2 , '0'+ TEXT(HOUR(booking.Start_Time__c)), HOUR(booking.Start_Time__c))}
                                <apex:outputText value="{0,number,00}">
                                    <apex:param value="{!MINUTE(booking.Start_Time__c)}"/>
                                </apex:outputText>
                            </div>
                        </apex:column>
                        <apex:column headerValue="Job Details" styleClass="normalcell"
                                     width="500px" headerClass="job-headers"
                                     rendered="{!booking.Booking_Type__c != 'Meal Break'}">
                            <div class="boldcell">
                                <apex:variable var="showDaysActive" value="{!booking.Id != route.Bookings__r[0].Id}"/>
                                <apex:outputField value="{!booking.Booking_Location_Name_LU__c}"/>
                                <apex:outputText
                                        rendered="{! OR(!ISBLANK(booking.Booking_Location_Street__c),!ISBLANK(booking.Booking_Location_City__c))}">
                                    (
                                    <apex:outputField value="{!booking.Booking_Location_Street__c}"/>
                                    &nbsp;
                                    <apex:outputField value="{!booking.Booking_Location_City__c}"/>
                                    )<br/>
                                </apex:outputText>
                            </div>
                            <apex:outputText value="{! booking.Booking_Type__c}" styleClass="normalcell"/>
                            <span style="margin-left: 40px; display: block;">
                            <apex:outputField value="{!booking.Booking_Comments__c}" styleClass="normalcell"/>
                        </span>
                            <apex:outputText rendered="{! !ISBLANK(booking.Booking_Comments__c)}">
                            </apex:outputText>
                            <span style="margin-left: 40px;">
                        <apex:outputField value="{!booking.Key_Number__c}" styleClass="normalcell"/>
                        </span>
                            <br/>
                        </apex:column>
                        <b>
                            <apex:column headerValue="Docks" styleClass="normalcell" width="50px"
                                         headerClass="job-headers"
                                         rendered="{!booking.Booking_Type__c != 'Meal Break'}">
                                <apex:outputField value="{! booking.Dock_Number__c}" style="font-size:small"/>
                            </apex:column>
                            <apex:column headerValue="Depart" styleClass="boldcell"
                                         width="50px"
                                         headerClass="job-headers"
                                         rendered="{!booking.Booking_Type__c != 'Meal Break'}">
                                <b>
                                    <apex:variable var="bookingEndTime"
                                                   value="{! booking.Start_Time__c+booking.Dwell_Time_Planned__c*60000}"/>
                                    <!-- display time in hhmm format -->
                                    {! IF(LEN(TEXT(HOUR(bookingEndTime)))<2 , '0'+ TEXT(HOUR(bookingEndTime)), HOUR(bookingEndTime))}
                                    <apex:outputText value="{0,number,00}">
                                        <apex:param
                                                value="{!MINUTE(bookingEndTime)}"/>
                                    </apex:outputText>
                                </b>
                            </apex:column>
                        </b>
                    </apex:pageBlockTable>
                </apex:pageBlock>
            </div>
        </div>
        <apex:variable var="routeCounter" value="{!routeCounter+1}"/>
    </apex:repeat>
</apex:page>