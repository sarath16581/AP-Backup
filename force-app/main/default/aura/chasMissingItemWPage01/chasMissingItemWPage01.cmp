<!--
  * @changeLog :
  * @date         : 19/06/2020
  * Modified by   : Hara Sahoo
  * @description  : 1. Added a card layout outer-box
  * @Modifield by Hara Sahoo - 11/01/2020 - Changes made as part of enquiry submission in an unauthenticated user context 
  * Modifield by Hara Sahoo - 09/03/2021 - Changes made as part of tracking id and dpid url paramteres and auto-progression
  * Modified by Phap Mai - 10/05/2021 - DDS-5488: When consignment API returns 404, route the cases to domestic queue
  * Modified by Mahesh Parvathaneni - 19/05/2022 - DDS-7472: When consignment API returns 404, show the warning message
  * Modified by Hasantha Liyanage - 04/08/2022 - DDS-11626: before edd
-->
<aura:component extends="c:SS_uiWizardPage" implements="forceCommunity:searchInterface" controller='ChasApexController' description="Missing Items wizard page 1: Item details (API call)">
    <aura:attribute name="error500" type="Boolean" default="false"/>
    <aura:attribute name="error400" type="Boolean" default="false"/>
    <aura:attribute name="isLoading" type="Boolean" default="false"/>
    <aura:attribute name="isFromBackButton"  type="Boolean" default="false" />
    <aura:attribute name="dpidFromUrl"  type="String" default="" />
    <aura:attribute name="trackingIdFromUrl"  type="String" default="" />
    <aura:attribute name="displaySpinner" type="Boolean" default="false"/>
    <aura:attribute name="isMultipleArticles" type="Boolean" default="false"/>
    <aura:attribute name="showSelectionError" type="Boolean" default="false"/>
    <aura:attribute name="showInvalidMessage" type="Boolean" default="false"/>
    <aura:attribute name="showInvalidWithinEDDMessage" type="Boolean" default="false"/>
    <aura:attribute name="eddDisplayDate"  type="String" default="" />
    <!-- Guest login attributes-->
    <aura:attribute name="displaymyPostLoginForm" type="Boolean" default="false" />
    <aura:handler name="chasmyPostLogin" event="c:ChasMyPostLogin" action="{!c.displaymyPostLoginForm}"/>
    <aura:attribute name="authenticatedURL" type="String" />
    <!-- Added below code on 24/10/2018 for parsing and setting the Tracking Id passed from App view to the Missing Items form. -->
    <aura:handler name="init" value="{!this}" action="{!c.doInit}" />
    <aura:handler name="chasGenComponentEvent" event="c:chasGenComponentEvent" action="{!c.onchange}"/>

    <!--Autoprogress this form if the url parameters are passed, for rest of every other scenario continue allow user to enter the tracking id-->
    <aura:if isTrue="{!or(v.isFromBackButton, or(empty(v.dpidFromUrl) ,and(not(empty(v.dpidFromUrl)),empty(v.trackingIdFromUrl))))}">
        <aura:if isTrue="{!(v.isMultipleArticles)}">
            <div class="left-padding">
                <img src="sfsites/c/resource/ChasIcons/chas-icons/pngs/UI/icons/back_arrow.png" alt="Go back"/><label>&nbsp;</label>
                <lightning:button label="BACK" variant="base" onclick="{!c.goBack}" class="goBack"/>
            </div>
        </aura:if>
    <legend class="chas-header left-padding">
      <aura:if isTrue="{! not (v.isMultipleArticles)}">
        <h2>Enter your tracking number</h2>
      </aura:if>
      <aura:if isTrue="{!(v.isMultipleArticles)}">
        <h2>Item details</h2>
      </aura:if>
    </legend>
    <c:ChasForm customStyle="left-padding">
        <!-- Login was successful, user authenticated -->
        <aura:if isTrue="{!v.authUserData.isUserAuthenticated == true}">
            <!-- Dont present the login options-->
            <aura:set attribute="else">
                <!-- User is un-authenticated/guest -->
                <!-- Present user with login options authenticated/ un-authenticated-->
                <div class="slds-grid-address-login login-block">
                    <div class="slds-col state-col-width">
                        <c:ChasLoginOptions label="Continue with MyPost" myPostLogin="true" subLabel="to pre-fill some details. You'll also be able track your enquiry online."/>
                    </div>
                    <div class="slds-col separator-vertical separator-horizontal">
                        <hr/>
                    </div>
                    <div class="slds-col state-col-width">
                        <c:ChasLoginOptions label="Continue as a guest" subLabel="Enter all your details, then get updates on your enquiry via email or phone."/>
                    </div>
                </div>  
            </aura:set>
        </aura:if>
        <div class="outer-box">
            <!-- Invalid Tracking number message -->
            <aura:if isTrue="{!(v.showInvalidMessage)}">
                <div class="tracking-error">
                    <c:ChasBspDeflection aura:id="invalidBsp" noInfoIcon="true" hasClose="true" borderStyle="info-box bottom-gap" iconLink="{!$Resource.ChasIcons + '/chas-icons/svgs/UI/icons/chas-warn-circle.svg'}" iconLinkStyle="message-icon">
                        <p class="message-text">We couldn't find this tracking number in our records. Please check the tracking number and try again.</p>
                        <p class="message-text slds-var-p-top_medium">You can also check with the sender that they've shared the right tracking number.</p>
                    </c:ChasBspDeflection>
                </div>
            </aura:if>
            <!-- EDD before date message -->
            <aura:if isTrue="{!(v.showInvalidWithinEDDMessage)}">
                <div class="tracking-info">
                    <c:ChasBspDeflection aura:id="invalidEdd" noInfoIcon="true" hasClose="true" borderStyle="info-box bottom-gap" iconLink="{!$Resource.ChasIcons + '/chas-icons/svgs/UI/icons/chas-info-circle.svg'}" iconLinkStyle="message-icon">
                        <p class="message-text">This parcel is on track to be delivered {!if(v.wizardData.deliveredByDateFrom  != null, 'between', 'on')} <b>{!v.eddDisplayDate} </b> </p>
                        <br/>
                        <p class="message-text"> You can only enquire about a late or missing item after the expected delivery date. For essential medication enquiries,
                            <a href="https://auspost.com.au/help-and-support#contact" class="link-plain" target="blank" >please contact us by phone.</a>
                        </p>
                    </c:ChasBspDeflection>
                </div>
            </aura:if>

            <!-- Tracking Number -->
            <aura:if isTrue="{!!(v.isMultipleArticles)}">
            <div class="form-input-container">
                <c:ChasInputSearch
                                   aura:id='ChasTrackingId'
                                   name='ChasTrackingId'
                                   required="true"
                                   label='Tracking number'
                                   value='{! v.wizardData.trackingId }'
                                   onclick='{! c.searchTrackingNumberService}'
                                   maxlength='50'
                                   isLoading="{! v.isLoading }"
                                   />
            </div>
            </aura:if>
            <aura:if isTrue="{!(v.isMultipleArticles)}">
              <div class="item-detail-header">Consignment number</div>
              <div  style="border: 0.7px solid; padding: 5px; margin-bottom: 25px; border-radius: 6px; padding: 10px; margin-top: 15px;">
                    <div style="font-weight: bold; font-size: 18px;">{!v.wizardData.trackingId}</div>
                </div>
                <div class="item-detail-header">Please select the item(s) you'd like to raise a case for</div>
                <div style="margin-bottom: 10px; margin-top: 15px;">
                    <c:ChasErrorMessages error="Please select at least one item" showError="{! v.showSelectionError }"/>
                </div>
                <c:chasArticles articles="{!v.wizardData.articles}" onisselected="{!c.isSelected}"/>
                <div style="margin-bottom: 25px;">
                    <c:ChasNavButtons nextLabel="Continue" disabled="false" nextAction="{! c.selectionMade }"/>
                </div>
            </aura:if>
            <aura:if isTrue="{!(v.error400)}">
                <div class="slds-p-bottom_medium">
                    <p>Not sure what this means? <a onclick='{!c.navToLearnMore}'><u>Learn more</u></a></p>
                </div>
            </aura:if>
            <aura:if isTrue="{! not(v.error500) }">
                <div class="faq-section">
                    <c:ChasExpandableSection label="Where can I find my tracking number?" >
                        <h3 class="chas-body_regular slds-m-bottom_xx-small">Sender</h3>
                        <p class="slds-m-bottom_small">Your tracking number will be on:
                            <ul>
                                <li>your Post Office receipt </li>
                                <li>the barcode or removable sticker of your pre-paid satchel. </li>
                            </ul>
                        </p>
                        <h3 class="chas-body_regular slds-m-bottom_xx-small">Recipient</h3>
                        <p>Check your order confirmation, invoice or emails from your sender to find your tracking number.</p>
                    </c:ChasExpandableSection>
                    
                    <c:ChasExpandableSection label="Can I track an item without the tracking ID?" darkTheme="false" grouped="true" >
                        <h3 class="chas-body_regular slds-m-bottom_xx-small">Don't have a tracking number?</h3>
                        <p>We deliver so many items every day that, without knowing your tracking number, unfortunately there's not a great deal we can do to locate it.</p>
                    </c:ChasExpandableSection>
                </div>
                <aura:set attribute="else">
                    <c:ChasInfoTile heading="Whoops, something's gone wrong." image="/chas-icons/pngs/UI/icons/it_error.png">
                        <p>Please try again in a few minutes.</p>
                    </c:ChasInfoTile>
                </aura:set>
            </aura:if>
        </div>
    </c:ChasForm>
    <aura:set attribute="else">
            <lightning:spinner class="{!if(v.displaySpinner, '', 'slds-hidden')}"/>
        </aura:set>
    </aura:if>
</aura:component>