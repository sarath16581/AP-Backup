define(["util","integration","config","i18next","SFDC/tracking","agent/interaction"],function(e,n,o,l,a,r){var c="SFDC/case: ",t=null,s={},i=function(e){if(console.log(c+"search"),o.caseSearchOverride)return o.caseSearchOverride(e);var r=$.Deferred(),s=e.ixn;if(o.SHOW_CASE&&t!==null&&s.userData!==void 0){var i=s.userData[t];console.log(c+"search "+t+"="+i),i!==void 0&&i!==""?ConnectorController.findCase(i,function(t){if(t!==null)console.log(c+"case found ("+t.Id+", "+t.ContactId+")"),ConnectorController.getContact(t.ContactId,null,function(e){e!==null?r.resolve(e,t.Id,i):(console.log(c+"contact not found"),r.reject())});else if(console.log(c+"case not found"),o.SEARCH_CASE_IF_WRONG_CASE){var u="/apex/CRMCaseSearch?id="+s.id+"&caseNumber="+i;console.log(c+"opening case search: "+u),a.setParams(e),n.console.openPrimaryTab(null,u,!0,l),r.resolve(null)}else console.log(c+"keep going with search"),r.reject()}):(console.log(c+"no case KVP in interaction"),r.reject())}else console.log(c+"no case search"),r.reject();return console.log(c+"search - finished"),r.promise()},u=function(e){if(console.log(c+"pop"),o.casePopOverride)return o.casePopOverride(e);var i=e.ixn,u=e.contact,d=e.searchKVP||null,g=e.caseId||null,f=e.caseNumber||null,p=e.popOnly||!1,C=e.noCase||!1,I=$.Deferred(),b=a.getPrimaryTabId(i.id);if(!o.SHOW_CASE||p||C)console.log(c+"no case pop"),I.reject();else{var v=a.getCurrentPrimaryTabId(),m=a.getCurrentPrimaryTabObjectId();if(o.NEW_CASE_ON_POP&&g===null){var _={};if(i.userData!==void 0){var S=o.CASE_MAP.split(",");$.each(S,function(e,n){var o=n.split(":"),l=o[0];if(o.length>1){var a=i.userData[o[1]];a!==void 0&&(console.log(c+"Map - "+l+":"+a),_[l]=a)}})}i.userData[d]!==void 0||o.NEW_CASE_IF_NO_SEARCH_KVP_PRESENT?ConnectorController.createCase(u?u.Id:null,u?u.AccountId||null:null,l.t("mediaType."+i.mediaType),l.t("case.new"),i.userData,_,function(e){if(e!==null){console.log(c+"redirect to new case - "+e.Id+" under "+b+" or "+v);var a=function(n){if(n.success){if(t!==null&&e.CaseNumber){var o={id:i.id,mediaType:i.mediaType,userData:{}};o.userData[t]=e.CaseNumber,u&&(s[u.Id]=e.CaseNumber);var l={Action:"AttachData",ActionData:{id:i.id,userData:o.userData}};r.attachData(l)}I.resolve(e.Id)}else console.warn(c+"could not open tab"),I.reject()},d="/"+e.Id;o.OPEN_NEW_CASE_IN_EDIT_MODE&&(d+="/e"),b!==null?(console.log(c+"primaryTabId="+b),n.console.openSubtab(b,d,!0,l.t("case.new"),null,function(e){a(e)})):v!==null&&m!==null&&(u&&m===u.Id||u&&m===u.AccountId)?(console.log(c+"currentPrimaryTabId="+v),n.console.openSubtab(v,d,!0,l.t("case.new"),null,function(e){a(e)})):(console.log(c+"open new primary tab"),n.console.openPrimaryTab(null,d,!0,l.t("case.new"),function(e){a(e)}))}else console.warn(c+"Could not create case"),I.reject()}):(console.log(c+"No present KVP - did not create case"),I.reject())}else if(g!==null){console.log(c+"redirect to existing case - "+g+" under "+b+" or "+v);var E=function(e){e.success?(s[u.Id]=f,I.resolve(g)):(console.warn(c+"could not open tab"),I.reject())},D="/"+g;o.OPEN_EXISTING_CASE_IN_EDIT_MODE&&(D+="/e"),b!==null?(console.log(c+"primaryTabId="+b),n.console.openSubtab(b,D,!0,l.t("case.existing"),null,function(e){E(e)})):v===null||m===null||m!==u.Id&&m!==u.AccountId?(console.log(c+"open new primary tab"),n.console.openPrimaryTab(null,D,!0,l.t("case.existing"),function(e){E(e)})):(console.log(c+"currentPrimaryTabId="+v),n.console.openSubtab(v,D,!0,l.t("case.existing"),null,function(e){E(e)}))}else console.log(c+"no case"),I.reject()}return console.log(c+"pop - finished"),I.promise()},d=function(e){console.log(c+"getCaseNumber contact - "+e);var n=s[e];return n===void 0&&(n=null),n},g=function(e){e!==null&&e!==""&&(t=e)};return{initialize:g,search:i,pop:u,getCaseNumber:d}})