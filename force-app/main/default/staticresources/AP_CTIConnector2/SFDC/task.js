define(["util","moment","integration","i18next","config","SFDC/tracking"],function(e,o,n,t,r,a){var l="SFDC/task: ",s=function(e){if(console.log(l+"start"),r.taskStartOverride)return r.taskStartOverride(e);var s=e.ixn,c=e.contact,i=e.caseId||null,d=e.popOnly||!1,u=$.Deferred();if(r.CREATE_TASK&&r.NEW_TASK_ON_POP&&!d){var I=i||(c?c.AccountId:null)||null,T=t.t("mediaType."+s.mediaType)+" "+o().format("YYYY-MM-DD HH:mm:ss"),f=a.getPrimaryTabId(s.id),g=a.getCurrentPrimaryTabId(),b=a.getCurrentPrimaryTabObjectId();console.log(l+"create task "+T);var m={};if(s.userData!==void 0){var p=r.TASK_MAP.split(",");$.each(p,function(e,o){var n=o.split(":"),t=n[0];if(n.length>1){var r=s.userData[n[1]];r!==void 0&&(console.log(l+"Map - "+t+":"+r),m[t]=r)}})}ConnectorController.createTask(s.id,c?c.Id:null,I,T,s.userData,m,function(e){if(e!==null){console.log(l+"redirect to new task - "+e.Id+" under "+f+" or "+g);var o=function(o){o.success?(a.setWhatId(s.id,I),a.setTaskTabId(s.id,o.id),a.setTaskId(s.id,e.Id),a.setCaseId(s.id,i),n.console.refreshPrimaryTabById(f||g,!1),u.resolve()):(console.warn(l+"could not open tab"),u.reject())},d="/"+e.Id;r.OPEN_INITIAL_TASK_IN_EDIT_MODE&&(d+="/e"),f!==null?(console.log(l+"primaryTabId="+f),n.console.openSubtab(f,d,!0,t.t("task.started"),null,function(e){o(e)})):g!==null&&b!==null&&(c&&b===c.Id||c&&b===c.AccountId||b===i)?(console.log(l+"currentPrimaryTabId="+g),n.console.openSubtab(g,d,!0,t.t("task.started"),null,function(e){o(e)})):(console.log(l+"open new primary tab"),n.console.openPrimaryTab(null,d,!0,t.t("task.started"),function(e){o(e)}))}else console.warn(l+"Could not create task"),u.reject()})}else console.log(l+"No task on pop"),u.reject();return console.log(l+"start - finished"),u.promise()},c=function(e,s,c,i){if(console.log(l+"finish"),r.taskFinishOverride)return r.taskFinishOverride(e,s,c,i);var d=$.Deferred();if(r.CREATE_TASK&&c.isConsult===void 0){var u=a.getPrimaryTabId(e),I=a.getTaskTabId(e),T=t.t("mediaType."+c.mediaType)+" "+o().format("YYYY-MM-DD HH:mm:ss");i===void 0&&(i=0),console.log(l+"create/update the task");var f=a.getWhatId(e),g=a.getCurrentPrimaryTabId(),b=a.getCurrentPrimaryTabObjectId(),m=a.getTaskId(e),p=function(e){e.success?(console.log(l+"tab shown"),n.console.refreshPrimaryTabById(u||g,!1),d.resolve()):(console.warn(l+"could not open tab"),d.reject())},v={};if(c.userData!==void 0){var k=r.TASK_MAP.split(",");$.each(k,function(e,o){var n=o.split(":"),t=n[0];if(n.length>1){var r=c.userData[n[1]];r!==void 0&&(console.log(l+"Map - "+t+":"+r),v[t]=r)}})}ConnectorController.closeTask(e,m,f,T,s,c.userData,r.DISPOSITION_KVP,v,i,function(o){if(o!==null){console.log(l+"redirect to new/existing task - "+o.Id+" under "+u+" or "+g);var s=a.getContact(e),c=a.getCaseId(e),i="/"+o.Id;r.OPEN_FINAL_TASK_IN_EDIT_MODE&&(i+="/e"),u!==null?(console.log(l+"primaryTabId="+u),I!==null&&n.console.closeTab(I),n.console.openSubtab(u,"/"+o.Id,!0,t.t("task.completed"),null,function(e){p(e)})):g!==null&&b!==null&&(s&&b===s.Id||s&&b===s.AccountId||b===c)?(console.log(l+"currentPrimaryTabId="+g),I!==null&&n.console.closeTab(I),n.console.openSubtab(g,o.Id,!0,t.t("task.completed"),null,function(e){p(e)})):(console.log(l+"open new primary tab"),I!==null&&n.console.closeTab(I),n.console.openPrimaryTab(null,"/"+o.Id,!0,t.t("task.completed"),function(e){p(e)}))}else console.warn(l+"could not go to task"),d.reject()})}else console.log(l+"No task on close"),d.reject();return console.log(l+"finish - finished"),d.promise()};return{start:s,finish:c}})