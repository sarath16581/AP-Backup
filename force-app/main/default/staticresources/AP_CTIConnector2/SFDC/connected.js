define(["util","i18next","integration","agent/voice","config","SFDC/tracking","SFDC/case","SFDC/task","SFDC/pop","agent/interaction"],function(e,o,n,c,a,l,t,r,s,i){function d(e){var o=JSON.parse(e.message);switch(console.log("receiveSFMessage CTIEvent = "+o.action),o.action){case"AttachData":i.attachData(o);break;case"MarkDone":i.markDone(o);break;case"ReleaseCall":i.releaseCall(o);break;case"UserEvent":i.userEvent(o);break;case"ContactSelected":console.log(h+"ContactSelected - "+o.objectId+", "+o.id),ConnectorController.getContact(o.objectId,null,function(e){var n=l.getParams(o.id);n!==null&&(n.contact=e,s.start(n))});break;case"CaseSelected":console.log(h+"CaseSelected - "+o.objectId+", "+o.id),ConnectorController.getContact(o.objectId,null,function(e){var n=l.getParams(o.id);n!==null&&(n.contact=e,n.caseId=o.caseId,n.caseNumber=o.caseNumber,s.start(n))})}}function u(e){var o=JSON.parse(e.result),n=null,l=null;console.log(h+o.number),a.beforeDial&&(console.log(h+"go to custom dial handler"),a.beforeDial(o));var r={phoneNumber:o.number,userData:o.userData?o.userData:{}},s=function(){var e=$.Deferred();if(o.object==="Contact")n=t.getCaseNumber(o.objectId),l=o.objectId,console.log(h+"case number is "+n+", contact is "+l),e.resolve();else if(o.object==="Account")l=o.contactId,console.log(h+"contact is "+l),e.resolve();else if(o.object==="Case")n=o.objectName,console.log(h+"case number is "+n),e.resolve();else if(o.object==="Task"){var c=o.objectId;console.log(h+"task is "+c),ConnectorController.getContactByTask(c,function(o){l=o.WhoId,n=o.CallObject,console.log(h+"contact is "+l+", case number is "+n),e.resolve()})}else console.log(h+"object is "+o.object),e.resolve();return e},i=function(){var e=$.Deferred();try{f.searchVoiceKVP!==""?s().done(function(){n!==null&&f.searchCaseKVP!==""&&(r.userData[f.searchCaseKVP]=n),l!==null?ConnectorController.getContact(l,f.searchVoiceField,function(o){if(o!==null){var n=o[f.searchVoiceField];n!==null&&(console.log(h+"voice field is "+n),r.userData[f.searchVoiceKVP]=n)}e.resolve()}):e.resolve()}):e.resolve()}catch(o){console.error(h+o.stack),e.resolve()}return e};i().done(function(){c.dial(r)})}var h="SFDC/connected: ",f=null,p=function(c){try{console.log(h+"initialize"),f=c,t.initialize(c.searchCaseKVP),n.interaction.cti.enableClickToDial(),n.interaction.cti.onClickToDial(u),n.console.addEventListener("CTIEvent",d),n.console.onFocusedPrimaryTab(l.primaryTabFocused),e.getInstance("voice.pop").subscribe(function(e){console.log(h+"voice.pop");var o=e.call;o.isConsult=e.isConsult;try{var n=function(e){if(console.log(h+"aniSearch"),o.callType==="Internal")return console.log(h+"is internal call"),void 0;var n=o.ani;o.callType==="Outbound"&&(n=o.dnis),console.log(h+"ANI="+n),a.NO_ANI_SEARCH?(console.log(h+"aniSearch - not enabled"),p(e,"phoneNumber",n)):ConnectorController.findContact("Phone",n,function(o){o!==null?o.Id===void 0?(console.log(h+"contact search - multiple contacts"),p(e,"phoneNumber",n,!0)):(o.Name=$("<div/>").html(o.Name).text(),console.log(h+"findContact - "+o.Id+", "+o.Name),e.contact=o,s.start(e)):(console.log(h+"contact search - no records found"),p(e,"phoneNumber",n))}),console.log(h+"aniSearch - finished")},l={searchField:e.fieldName,searchValue:e.fieldValue,searchType:c.voiceSearchType,ixn:o,popOnly:o.isConsult!==void 0,noCase:o.callType==="Outbound"};a.overrideVoicePop?a.overrideVoicePop(o,l,n,i):t.search(l).then(function(e,o,n){e!==null&&(l.contact=e,l.caseId=o,l.caseNumber=n,s.start(l))},function(){return i(l)}).then(null,function(){n(l)})}catch(r){console.error(h+r.stack)}console.log(h+"voice.pop - finished")}),e.getInstance("voice.ended").subscribe(function(e){console.log(h+"voice.ended");try{var o=e.call,n=o.id;if(l.exists(n)){var c="";o.notes&&(c+="Note:\n"+o.notes+"\n\n"),r.finish(n,c,o,o.duration).done(function(){l.remove(n)})}else console.log(h+"could not find "+n)}catch(a){console.error(h+a.stack)}}),e.getInstance("email.pop").subscribe(function(e){console.log(h+"email.pop");var o=e.email,n={searchField:e.fieldName,searchValue:e.fieldValue,searchType:c.emailSearchType,ixn:o};t.search(n).then(function(e,o,c){e!==null?(console.log(h+"email.pop - attempt pop"),n.contact=e,n.caseId=o,n.caseNumber=c,s.start(n)):console.log(h+"email.pop - no pop")},function(){return console.log(h+"email.pop - do field search"),i(n)}).then(null,function(){return console.log(h+"email.pop - do search based on from"),p(n,"email",o.from)})}),e.getInstance("email.ended").subscribe(function(e){console.log(h+"email.ended");try{var o=e.email,n=o.id;if(l.exists(n)){var c="";o.notes&&(c+="Note:\n"+o.notes+"\n\n"),c+="Email\n",c+="Msg: "+o.emailDescription,r.finish(n,c,o,o.duration).done(function(){l.remove(n)})}else console.log(h+"could not find "+n)}catch(a){console.error(h+a.stack)}}),e.getInstance("chat.pop").subscribe(function(e){console.log(h+"chat.pop");var o=e.chat,n={searchField:e.fieldName,searchValue:e.fieldValue,searchType:c.chatSearchType,ixn:o};t.search(n).then(function(e,o,c){e!==null&&(n.contact=e,n.caseId=o,n.caseNumber=c,s.start(n))},function(){return i(n)}).then(null,function(){return p(n,n.searchType,n.searchValue)})}),e.getInstance("chat.ended").subscribe(function(e){console.log(h+"chat.ended");try{var o=e.chat,n=o.id;if(l.exists(n)){var c="";o.notes&&(c+="Note:\n"+o.notes+"\n\n"),c+="Transcript:\n"+o.transcript,r.finish(n,c,o,o.duration).done(function(){l.remove(n)})}else console.log(h+"could not find "+n)}catch(a){console.error(h+a.stack)}}),e.getInstance("openmedia.pop").subscribe(function(e){console.log(h+"openmedia.pop");var o=e.openmedia,n={searchField:e.fieldName,searchValue:e.fieldValue,searchType:c.openmediaSearchType,ixn:o};t.search(n).then(function(e,o,c){e!==null&&(n.contact=e,n.caseId=o,n.caseNumber=c,s.start(n))},function(){return i(n)}).then(null,function(){return p(n,n.searchType,n.searchValue)})}),e.getInstance("openmedia.ended").subscribe(function(e){console.log(h+"openmedia.ended");try{var o=e.openmedia,n=o.id;if(l.exists(n)){var c="";o.notes&&(c+="Note:\n"+o.notes+"\n\n"),o.transcript&&(c+="Transcript:\n"+o.transcript),r.finish(n,c,o,o.duration).done(function(){l.remove(n)})}else console.log(h+"could not find "+n)}catch(a){console.error(h+a.stack)}}),e.getInstance("preview.pop").subscribe(function(e){console.log(h+"preview.pop");var o=e.record,n=function(){var n=o.phone;console.log(h+"phoneSearch - "+n);var c={ixn:o,searchValue:e.fieldValue,popOnly:!0};ConnectorController.findContact("Phone",n,function(o){o!==null?o.Id===void 0?(console.log(h+"contact search - multiple contacts"),p(c,"phoneNumber",n,!0)):(o.Name=$("<div/>").html(o.Name).text(),console.log(h+"phoneSearch: "+o.Id+", "+o.Name+" ("+e.record.id+")"),c.contact=o,s.start(c)):(console.log(h+"contact search - no records found"),p(c,"phoneNumber",n))}),console.log(h+"phoneSearch - finished")},a={searchField:e.fieldName,searchValue:e.fieldValue,searchType:c.voiceSearchType,ixn:o,popOnly:!0};i(a).then(null,n)});var i=function(e){var o=$.Deferred(),n=e.searchField,c=e.searchValue,a=e.ixn,l=e.searchType||null;try{console.log(h+"fieldSearch"),n!==null&&c!==null?(console.log(h+"fieldSearch - search field="+n),console.log(h+"fieldSearch - search value="+c),c!==void 0&&c!==""?ConnectorController.findContact(n,c,function(n){n!==null?(n.Id===void 0?(console.log(h+"fieldSearch - multiple contacts"),p(e,l,c,!0)):(n.Name=$("<div/>").html(n.Name).text(),console.log(h+"fieldSearch - "+n.Id+", "+n.Name+" ("+a.id+")"),e.contact=n,s.start(e),console.log(h+"fieldSearch - success for "+a.id)),o.resolve()):(console.log(h+"fieldSearch - no field value found"),o.reject())}):(console.log(h+"fieldSearch - no field KVP in interaction"),o.reject())):(console.log(h+"fieldSearch - no field search"),o.reject())}catch(t){console.error(h+t.stack),o.reject()}return console.log(h+"fieldSearch - finished"),o.promise()},p=function(e,c,t,r){console.log(h+"doSearch - "+c+", "+t);var i=$.Deferred(),d="/apex/CRMDefaultSearch?id="+e.ixn.id;return a.NO_DEFAULT_SEARCH&&!r?(console.log(h+"doSearch - not enabled, do pop instead"),s.start(),i.resolve()):t!==void 0&&t!==null&&t!==""&&c!==null?(d+="&"+c+"="+t,console.log(h+"url="+d),l.setParams(e),n.console.openPrimaryTab(null,d,!0,o.t("search.search")),i.resolve()):(console.log(h+"url="+d),l.setParams(e),n.console.openPrimaryTab(null,d,!0,o.t("search.search")),i.reject()),i.promise()}}catch(g){console.error(h+"ERROR - "+g.stack)}console.log(h+"initialized"),e.getInstance("sfdc.connected").publish("initialized")};return{initialize:p}})