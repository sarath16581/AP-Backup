define(["jquery","util","config","agent/session"],function(e,a,t,n){function s(e){console.log(l+"processMessage "+e.action);console.log(e);var t={};switch(e.action){case"OpenObject":switch(e.type){case"Voice":t={channel:"/v2/me/calls",data:{notificationType:"StatusChange",call:{id:e.id,state:"Established",ani:e.source,dnis:e.destination,callType:e.calltype,userData:e.userData},messageType:"CallStateChangeMessage",fieldName:e.fieldName,fieldValue:e.fieldValue}};break;case"Email":t={channel:"/v2/me/emails",data:{notificationType:"StatusChange",email:{id:e.id,state:"Processing",to:e.destination,from:e.source,userData:e.userData},messageType:"EmailStateChangeMessage",fieldName:e.fieldName,fieldValue:e.fieldValue}};break;case"Chat":t={channel:"/v2/me/chats",data:{notificationType:"StatusChange",chat:{id:e.id,state:"Chatting",userData:e.userData},messageType:"ChatStateChangeMessage",fieldName:e.fieldName,fieldValue:e.fieldValue}};break;case"Preview":t={channel:"/v2/me/outbound",data:{notificationType:"StatusChanged",record:{id:e.id,state:"ReadyToCall",phone:e.destination,customFields:e.customFields},messageType:"OutboundRecordMessage",fieldName:e.fieldName,fieldValue:e.fieldValue}};break;case"OpenMedia":t={channel:"/v2/me/openmedia",data:{notificationType:"StatusChange",openmedia:{id:e.id,state:"Processing",mediaType:e.mediaType,userData:e.userData},messageType:"OpenMediaStateChangeMessage",fieldName:e.fieldName,fieldValue:e.fieldValue}}}a.getInstance("genesys.message").publish(t);break;case"CreateActivity":switch(e.type){case"Voice":t={channel:"/v2/me/calls",data:{notificationType:"StatusChange",call:{id:e.id,state:"Completed",ani:e.source,dnis:e.destination,callType:e.calltype,duration:e.duration,notes:e.notes,userData:e.userData},messageType:"CallStateChangeMessage"}};break;case"Email":t={channel:"/v2/me/emails",data:{notificationType:"StatusChange",email:{id:e.parentId||e.id,state:"Completed",duration:e.duration,notes:e.notes,emailDescription:e.emailDescription,userData:e.userData},messageType:"EmailStateChangeMessage"}};break;case"Chat":t={channel:"/v2/me/chats",data:{notificationType:"StatusChange",chat:{id:e.id,state:"Completed",duration:e.duration,notes:e.notes,transcript:e.transcript,userData:e.userData},messageType:"ChatStateChangeMessage"}};break;case"OpenMedia":t={channel:"/v2/me/openmedia",data:{notificationType:"StatusChange",openmedia:{id:e.id,mediaType:e.mediaType,state:"Completed",duration:e.duration,notes:e.notes,transcript:e.transcript,userData:e.userData},messageType:"OpenMediaStateChangeMessage"}}}a.getInstance("genesys.message").publish(t);break;case"ConnectionDenied":a.getInstance("glue.state").publish("not connected")}}function i(){var n={CI:u};e.ajax({url:t.URL+"/poll="+JSON.stringify(n),type:"GET",timeout:5e3,async:!0,crossDomain:!0,cache:!1,dataType:"jsonp",success:function(e){e.action!=="NoWork"&&s(e),connectionTimeout=setTimeout(function(){i()},100)},error:function(e,n,s){console.error(l+t.URL+" "+e.status+" "+s),a.getInstance("glue.state").publish("not connected"),connectionTimeout=setTimeout(function(){o()},5e3)}})}function o(){if(t.IS_UNIT_TEST)a.getInstance("glue.state").publish("connected");else{console.log(l+"requestConnection");var n={action:"ConnectionRequest",pollInterval:"100",CI:u};e.ajax({url:t.URL,data:"/request="+JSON.stringify(n),type:"GET",timeout:5e3,async:!0,crossDomain:!0,cache:!1,dataType:"jsonp",success:function(e){e.action==="ConnectionAccepted"?(console.log(l+"accepted"),a.getInstance("glue.state").publish("connected"),i()):e.action==="ConnectionDenied"?(console.warn(l+"connection denied, do not retry"),a.getInstance("glue.state").publish("not connected"),d=setTimeout(function(){o()},5e3)):d=setTimeout(function(){o()},5e3)},error:function(e,a,n){console.error(l+t.URL+" "+e.status+" "+n),d=setTimeout(function(){o()},5e3)}})}}function c(e){try{console.log(l+"initialize"),a.getInstance("glue.state").publish("connecting"),t.URL="https://"+(e.useLocalHost?"localhost":"127.0.0.1")+":"+e.pollPort,t.CI=u,t.PERSIST_USER_SETTINGS=e.persistUserSettings,t.SHOW_CONTACT=e.showContact,t.POP_ON_CONSULT_CALL=e.popOnConsultCall,t.NO_DEFAULT_SEARCH=e.noDefaultSearch,t.NO_ANI_SEARCH=e.noANISearch,t.SHOW_CASE=e.showCase,t.NEW_CASE_ON_POP=e.newCaseOnPop,t.NEW_CASE_IF_NO_SEARCH_KVP_PRESENT=e.newCaseIfNoSearchKVPPresent,t.SEARCH_CASE_IF_WRONG_CASE=e.searchCaseIfWrongCase,t.OPEN_NEW_CASE_IN_EDIT_MODE=e.openNewCaseInEditMode,t.OPEN_EXISTING_CASE_IN_EDIT_MODE=e.openExistingCaseInEditMode,t.CREATE_TASK=e.createTask,t.NEW_TASK_ON_POP=e.newTaskOnPop,t.OPEN_INITIAL_TASK_IN_EDIT_MODE=e.openInitialTaskInEditMode,t.OPEN_FINAL_TASK_IN_EDIT_MODE=e.openFinalTaskInEditMode,t.CASE_MAP=e.caseMap,t.TASK_MAP=e.taskMap,t.DISPOSITION_KVP=e.dispositionKVP,n.initialize(),o()}catch(s){console.error(l+"ERROR - "+s.message)}}var l="Glue: ",d=null,u=(new Date).getTime()+"a",r=function(){console.log(l+"terminate")};return{initialize:c,terminate:r}})